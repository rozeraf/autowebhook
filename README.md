# AutoWebhook

[![npm version](https://img.shields.io/npm/v/@yourname/autowebhook.svg)](https://www.npmjs.com/package/@yourname/autowebhook)
[![License: GPL-3.0-only](https://img.shields.io/badge/License-GPL--3.0--only-blue.svg)](https://www.gnu.org/licenses/gpl-3.0.html)
[![Powered by Bun](https://img.shields.io/badge/powered%20by-Bun-black.svg?style=flat&logo=bun)](https://bun.sh)

**AutoWebhook** — это библиотека для Node.js и Bun, которая автоматически создает и управляет туннелем [ngrok](https://ngrok.com/). Она обеспечивает стабильный публичный URL для вашего локального сервера, что идеально подходит для разработки и тестирования вебхуков для ботов (Telegram, Discord, Slack и др.), API и других сервисов.

Библиотека запускает ngrok в фоновом режиме, отслеживает его состояние, автоматически перезапускает в случае сбоев и предоставляет простой API для получения актуального URL.

## Зачем нужен AutoWebhook?

При разработке ботов или сервисов, использующих вебхуки, вы сталкиваетесь с необходимостью иметь публичный HTTPS URL, который может принимать запросы от внешних платформ (например, Telegram). Ngrok отлично решает эту задачу, но требует ручного запуска, а бесплатная версия предоставляет временные URL, которые меняются при каждом перезапуске.

**AutoWebhook** автоматизирует этот процесс:
- **Автоматический запуск**: Запускает ngrok вместе с вашим приложением.
- **Стабильный URL**: Автоматически получает URL туннеля и передает его в ваше приложение.
- **Мониторинг и перезапуск**: Встроенная проверка работоспособности (health check) отслеживает состояние туннеля и перезапускает ngrok при сбоях, обеспечивая "вечный" вебхук для разработки.
- **Простота**: Убирает необходимость в ручных действиях и дополнительных скриптах.

## Основные возможности

- **Автоматическое управление туннелем ngrok**: Запуск, остановка и перезапуск в фоновом режиме.
- **Извлечение URL**: Парсит вывод ngrok для получения публичного URL.
- **Проверка работоспособности**: Опциональный компонент для мониторинга состояния туннеля и конечной точки вашего приложения.
- **Надежность**: Автоматический перезапуск при потере соединения или сбоях.
- **Гибкая настройка**: Возможность указать порт, регион ngrok, субдомен, токен аутентификации и параметры проверки работоспособности.
- **Событийная архитектура**: Получайте уведомления о готовности (`ready`), перезапуске (`restarting`) и ошибках (`error`).
- **Поддержка TypeScript**: Полная типизация для надежной разработки.

## Установка

```bash
bun add @yourname/autowebhook
# или с npm
npm install @yourname/autowebhook
# или с yarn
yarn add @yourname/autowebhook
```

## Быстрый старт

Вот как можно настроить вебхук для Telegram-бота за несколько строк:

```typescript
// bot.ts
import { AutoWebhook } from '@yourname/autowebhook';
import { Bot } from 'grammy'; // Пример с grammy

// 1. Инициализируем AutoWebhook, указав порт вашего локального сервера
const webhook = new AutoWebhook({ port: 3000 });

// 2. Создаем экземпляр бота
const bot = new Bot('YOUR_TELEGRAM_BOT_TOKEN');

// 3. Запускаем туннель и получаем URL
const url = await webhook.start();

// 4. Устанавливаем вебхук
await bot.api.setWebhook(`${url}/webhook`);

console.log(`Бот запущен с вебхуком: ${url}`);

// Ваша логика для локального сервера, который будет слушать порт 3000
// ...
```

Больше примеров смотрите в файле [EXAMPLES.md](./EXAMPLES.md).

## Конфигурация

Вы можете настроить `AutoWebhook` через объект конфигурации в конструкторе:

```typescript
import { AutoWebhook } from '@yourname/autowebhook';

const config = {
  // Порт вашего локального сервера
  port: 8080,
  
  // Или команда для запуска, если у вас сложная логика
  // command: 'python -m http.server 8080',

  // Регион ngrok (us, eu, ap, au, sa, jp, in)
  region: 'eu',

  // Пользовательский субдомен (требует платного тарифа ngrok)
  subdomain: 'my-cool-bot',

  // Токен аутентификации ngrok
  auth: 'YOUR_NGROK_AUTHTOKEN',

  // Настройки проверки работоспособности
  healthCheck: {
    enabled: true,       // Включить проверку
    interval: 20000,     // Интервал проверки (мс)
    timeout: 10000,      // Таймаут запроса (мс)
    maxFailures: 3,      // Кол-во сбоев до перезапуска
  },

  // Коллбэки
  onUrlChange: (url) => console.log(`Новый URL: ${url}`),
  onError: (error) => console.error(`Произошла ошибка: ${error}`),
  onRestart: () => console.log('Перезапуск туннеля...'),
};

const webhook = new AutoWebhook(config);
await webhook.start();
```

### `AutoWebhookConfig`

| Поле          | Тип                               | По умолчанию | Описание                                                                                             |
|---------------|-----------------------------------|--------------|------------------------------------------------------------------------------------------------------|
| `port`        | `number`                          | `3000`       | Порт локального сервера, на который ngrok будет проксировать трафик.                                  |
| `command`     | `string`                          | `''`         | Альтернатива `port`. Команда для запуска ngrok (например, `http 80`). Переопределяет `port`.          |
| `region`      | `string`                          | `'eu'`       | Регион сервера ngrok.                                                                                |
| `subdomain`   | `string`                          | `''`         | Запросить конкретный субдомен (требует платного тарифа ngrok).                                         |
| `auth`        | `string`                          | `''`         | Ваш токен аутентификации ngrok.                                                                      |
| `healthCheck` | `HealthCheckConfig`               | `{...}`      | Объект конфигурации для модуля проверки работоспособности.                                           |
| `onUrlChange` | `(url: string) => void`           | `() => {}`   | Коллбэк, вызываемый при получении или изменении URL.                                                 |
| `onError`     | `(error: Error) => void`          | `() => {}`   | Коллбэк для обработки ошибок процесса ngrok.                                                         |
| `onRestart`   | `() => void`                      | `() => {}`   | Коллбэк, вызываемый перед попыткой перезапуска туннеля.                                              |

## API

### `webhook.start(): Promise<string>`
Запускает туннель ngrok и возвращает `Promise`, который разрешается публичным URL.

### `webhook.stop(): Promise<void>`
Останавливает туннель ngrok.

### `webhook.restart(): Promise<string>`
Принудительно перезапускает туннель и возвращает новый URL.

### `webhook.webhookUrl: string`
Возвращает текущий активный URL туннеля.

### `webhook.getStatus()`
Возвращает объект с текущим состоянием туннеля, включая `isRunning`, `currentUrl`, `isRestarting` и статус проверки работоспособности.

## События

Экземпляр `AutoWebhook` является `EventEmitter` и генерирует следующие события:

- `ready (url: string)`: Генерируется, когда туннель успешно запущен и URL получен.
- `restarting`: Генерируется перед попыткой перезапуска туннеля.
- `restarted (newUrl: string)`: Генерируется после успешного перезапуска.
- `error (error: Error)`: Генерируется при возникновении ошибки в процессе ngrok.
- `maxRestartsReached`: Генерируется, если достигнуто максимальное количество попыток перезапуска.

Пример использования:
```typescript
webhook.on('ready', (url) => {
  console.log(`Туннель готов: ${url}`);
});

webhook.on('error', (err) => {
  console.error('Ошибка ngrok:', err);
});
```

## Журнал изменений

Все изменения задокументированы в файле [CHANGELOG.md](./CHANGELOG.md).

## Лицензия

Этот проект распространяется под лицензией GPL-3.0-only. См. файл [LICENSE](./LICENSE) для получения дополнительной информации.